#!/bin/sh
set -e

#DEBHELPER#

. /usr/share/debconf/confmodule

CONFIG_FILE=/etc/opt/slapos/slapos.cfg

if [ ! -f "$CONFIG_FILE" ]; then
    NEW_CONFIG_FILE=$CONFIG_FILE
else
    NEW_CONFIG_FILE=/etc/opt/slapos/slapos.cfg.dpkg-new
fi

echo "# Never edit this file by hand as it has been automatically generated by
# debconf. You can change the settings at any time by running:
# ``dpkg-reconfigure -pmedium slapos-node''" > $NEW_CONFIG_FILE

cat < /usr/share/doc/slapos-node/examples/slapos.cfg >> $NEW_CONFIG_FILE

db_get slapos-node/master_url
MASTER_URL="$RET"
WITH_HTTPS=$(echo "$MASTER_URL" | grep -q "^https://" && echo true || echo false)

db_get slapos-node/computer_id
COMPUTER_ID="$RET"

sed -e "s#^\s*master_url\s*=.*#master_url = $MASTER_URL#" \
    -e "s#^\s*computer_id\s*=.*#computer_id = $COMPUTER_ID#" \
    -i $NEW_CONFIG_FILE

# Handle HTTPS URLs by just commenting/uncommenting the relevant lines
if $WITH_HTTPS; then
    sed -i 's/^\s*#\+\s*\(key_file\|cert_file\|certificate_repository_path\)/\1/' \
	$NEW_CONFIG_FILE

    # Renamed files
    test -f /etc/opt/slapos/ssl/slapos.crt && \
        mv /etc/opt/slapos/ssl/slapos.crt /etc/opt/slapos/ssl/computer.crt
    test -f /etc/opt/slapos/ssl/slapos.key && \
        mv /etc/opt/slapos/ssl/slapos.key /etc/opt/slapos/ssl/computer.key
else
    sed -i 's/^\s*[^#]*\s*\(key_file\|cert_file\|certificate_repository_path\)/#\1/' \
	$NEW_CONFIG_FILE
fi

db_get slapos-node/partition_amount
PARTITION_AMOUNT="$RET"

db_get slapos-node/ipv4_local_network
IPV4_LOCAL_NETWORK="$RET"

sed -e "s#^\s*partition_amount\s*=.*#partition_amount = $PARTITION_AMOUNT#" \
    -e "s#^\s*ipv4_local_network\s*=.*#ipv4_local_network = $IPV4_LOCAL_NETWORK#" \
    -i $NEW_CONFIG_FILE

if [ "$CONFIG_FILE" != "$NEW_CONFIG_FILE" ]; then
    ucfr slapos-node $CONFIG_FILE
    ucf --debconf-ok --three-way $NEW_CONFIG_FILE $CONFIG_FILE
    rm -f $NEW_CONFIG_FILE
fi

exit 0
